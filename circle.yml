# setup node environment
machine:
  node:
    version: 4.1.2
  environment:
    DB_HOST: localhost
    DB_NAME: circle_test
    DB_USER: ubuntu

# merge master before testing to make sure all tests pass
# with the updated version of master
checkout:
   post:
   # Sometimes git might ask for your identity and block the build. Add one valid account here:
    - git config user.email "inagi@andrew.cmu.edu" 
    - git config user.name "Imre Nagi"
   # Merge with master on CircleCI before running the tests.
    # - git rebase origin/master

database:
  override:
    - mysql -u ubuntu circle_test < ./sql/V1__create_users_and_public_messages_table.sql
#    - mysql -u ubuntu circle_test < ./sql/V2__interation2.sql

# install dependencies
# dependencies:
#   override:
#     - npm install bower -g
#     - npm install forever -g
#     - npm install promise -g
#     - npm install -g grunt-cli mocha istanbul
#     - npm install
#     - bower install

# run tests
test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/mocha
    - grunt circleci

deployment:
  production:
    branch: master
    heroku:
      appname: esn-f16-sa2
  development:
    branch: develop
    heroku:
      appname: esn-f16-sa2-staging
  testing:
    branch: feature/heroku
    heroku:
      appname: esn-f16-sa2-test
    commands:
      - heroku maintenance:on --app esn-f16-sa2-test
      - heroku scale worker=0 --app esn-f16-sa2-test
      - heroku run db-migrate up --app esn-f16-sa2-test
      - heroku scale worker=x --app esn-f16-sa2-test
      - heroku maintenance:off --app esn-f16-sa2-test

